<script>
  let selectedIcons = [];

  function promptLevel(label, min, max, defaultVal="1") {
    let v = prompt(`Enter ${label} (${min}-${max}):`, defaultVal);
    if (v === null) return null;              // user cancelled
    v = v.trim();
    const n = parseInt(v, 10);
    if (isNaN(n) || n < min || n > max) {
      alert(`Please enter a valid number between ${min} and ${max}.`);
      return null;
    }
    return n;
  }

  function selectIcon(iconName, panelType) {
    let existingIndex = selectedIcons.findIndex(icon => icon.name === iconName);

    if (existingIndex === -1) {
      if (panelType === 'squaddies') {
        // Squaddie: single level 1â€“5
        let levelNum = promptLevel(`the level for ${iconName}`, 1, 5, "1");
        if (levelNum === null) return; // cancelled or invalid
        selectedIcons.push({ name: iconName, level: levelNum, panel: panelType });

      } else if (panelType === 'heroes') {
        // Hero: three upgrades
        const powers = promptLevel(`Powers for ${iconName}`, 1, 5, "1");
        if (powers === null) return;

        const traits = promptLevel(`Traits for ${iconName}`, 1, 5, "1");
        if (traits === null) return;

        const turbo  = promptLevel(`Turbo for ${iconName}`, 1, 3, "1");
        if (turbo === null) return;

        selectedIcons.push({ 
          name: iconName, 
          panel: panelType, 
          powers: powers, 
          traits: traits, 
          turbo: turbo 
        });
      } else {
        // Unknown panel (just in case)
        return;
      }

    } else {
      // Deselect if already selected
      selectedIcons.splice(existingIndex, 1);
    }

    console.log("About to POST selectedIcons:", JSON.stringify(selectedIcons));

    // Send updated selection to backend
    fetch('/update_selection', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ selected_icons: selectedIcons })
    })
    .then(response => response.json())
    .then(data => {
      // Update scoreboard (your backend still returns these keys)
      document.getElementById("scoreboard").innerHTML = `
        Total Squaddie Levels: ${data.total_squaddie_levels} <br>
        Hero Count: ${data.hero_count} <br>
        Score: ${data.score}
      `;
    })
    .catch(error => console.error("Error updating selection:", error));

    updateIconStyles();
  }

  function toggleSelect(elem, panel = null) {
    elem.classList.toggle('selected');
    if (panel === 'squaddies') updateSquaddieCounter();
  }

  function deselectAll() {
    selectedIcons = [];
    fetch('/update_selection', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ selected_icons: [] })
    })
    .then(res => res.json())
    .then(data => {
      document.getElementById("scoreboard").innerHTML = `
        Total Squaddie Levels: ${data.total_squaddie_levels} <br>
        Hero Count: ${data.hero_count} <br>
        Score: ${data.score}
      `;
    })
    .catch(err => console.error("Error updating selection:", err));

    updateIconStyles();
  }

  function updateIconStyles() {
    document.querySelectorAll('.icon-wrapper').forEach(wrapper => {
      const iconName = wrapper.querySelector('.icon-label').innerText.trim();
      if (selectedIcons.some(icon => icon.name === iconName)) {
        wrapper.classList.add('selected');
      } else {
        wrapper.classList.remove('selected');
      }
    });
    if (typeof updateSquaddieCounter === 'function') updateSquaddieCounter();
  }

  function updateSquaddieCounter() {
    const selected = document.querySelectorAll('#squaddies-panel .icon-wrapper.selected').length;
    document.getElementById('squaddie-counter').textContent = `${selected} / 36`;
  }

  window.onload = updateSquaddieCounter;
</script>
